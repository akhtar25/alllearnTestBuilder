{{ form.hidden_tag() }}
<h4>Student Registration</h4>
<div class="form-group " style="padding-top:5px;">
  <div class="row">
    <div class="col-sm-9">
    <div class="row">
        <div class="col-sm-4">
          <label for="first_name">First Name</label>
          <input type="text" id="first_name" name="first_name" placeholder="First Name">
        </div>
        <div class="col-sm-4">
            <label for="last_name">Last Name</label>
            <input type="text" id="last_name" name="last_name" placeholder="Last Name">
          </div>
          <div class="col-sm-3">
            <label for="birthdate">Date of Birth</label>
            <input type="date" id="birthdate" name="birthdate">
          </div>
        </div>
    <div class="row">
        <div class="col-sm-11">
            <label for="address">Address</label>
          <input type="text" id="address" name="address" placeholder="Enter Address">
        </div>
    </div>
    <div class="row">
        <div class="col-sm-4">
            <div style="width:250px;">
                    {{ form.class_val.label(class='labelsize') }}
                    <br>
                    {% if form.class_val.errors %}
                    {{ form.class_val(class="form-control form-control-lg is-invalid") }}
                    <div class="invalid-feedback">
                    {% for error in form.class_val.errors %}
                     <span>{{ error }}</span>
                    {% endfor %}
                    </div>
                    {% else %}
                    {{ form.class_val(class='form-control') }}
                    {% endif %}
            </div>
    </div>
    <div class="col-sm-3">
            <div style="width:150px;" >
                            {{ form.section.label(class='labelsize') }}
                            <div id='loader'style='display: none; float: right;'>
                                            <img src='../static/images/spinner.gif' width='25px' height='25px'>
                                            </div>
                    <br>
                            {% if form.section.errors %}
                            {{ form.section(class="form-control form-control-lg is-invalid") }}
                            <div class="invalid-feedback">
                            {% for error in form.section.errors %}
                             <span>{{ error }}</span>
                            {% endfor %}
                    </div>
                            {% else %}
                            {{ form.section(class='form-control') }}
                            {% endif %}                                                
            </div>
    </div>
      <div class="col-sm-3">
        <label for="roll_number">Roll Number</label>
        <input type="number" id="roll_number" name="roll_number" min=1 placeholder="Roll No.">
      </div>
    </div>

    <div class="row">
        <div class="col-sm-3">
            <input type="file" style="height: 30px; margin-top: 10px;" id="file-input"><br>
            <input type="hidden" id="reference" name="reference" value="https://alllearndatabucketv2.s3.ap-south-1.amazonaws.com/question_references/images/cam.png">
        </div>
      </div>
        <div id="guardianbox" name="guardianbox">
        </div>
        <div class="row">
        <div class="col-sm-8">
        <p><input type='button' style=" float:right;width:150px; height:40px;" onclick="addGuardian();" value="Add Guardian"></p>
      </div>
    </div>
      
</div>
<div class="col-sm-3">
        <img style="border:1px solid gray;width:200px;" id="preview" src="https://alllearndatabucketv2.s3.ap-south-1.amazonaws.com/question_references/images/cam.png">
</div>

</div>
</div>



<script>
var class_select = document.getElementById("class_val");
        var section_select = document.getElementById("section");
        class_select.onchange = function()  {
             
            class_val = class_select.value;
            $("#loader").show();
            
            fetch('/resultUpload/' + class_val).then(function(response) {
                response.json().then(function(data) {
                        $("#loader").hide();    
                        var optionHTML = '';
                        for (var section of data.sections) {
                        optionHTML += '<option value="' + section.section_val + '">' + section.section_val + '</option>';
                    }
                    section_select.innerHTML = optionHTML;
                })
            });
        }
  var guardianbox_data='';
  var count=0;
  function addGuardian(){
  var row_id=document.getElementById('guardianbox');
  count+=1;
  var submitButton=' <p><button class="btn waves-light green lighten-1 white-text" style="margin-bottom: 5px;" type="submit" id="submit" name="submit" value="submit">Confirm</button></p>'
  guardianbox_data+=`<div class='row'>
  <h4 style="text-weight:Bold;">Guardian`+count+`</h4>
  <div class='col-sm-6'>
  <label for='guardian_name'>Guardian Name</label><input type='text' name='guardian_name' id='guardian_name' placeholder='guardian_name'></div>
  <div class='col-sm-5'><label for='guardian_phone'>Guardian Phone No.</label><input type='text' name='guardian_phone' id='guardian_phone' placeholder='guardian_phone'></div></div>
  <div class='row'><div class='col-sm-8'><label for='guardian_email'>Guardian Email</label><input type='email' id='guardian_email' name='guardian_email' placeholder='Email Address'></div></div>
  <div class='row'><div class='col-sm-6'>
    <div style="width:250px;">
        {{ form.relation.label(class='labelsize') }}
            <br>
        {% if form.relation.errors %}
        {{ form.relation(class="form-control form-control-lg is-invalid") }}
        <div class="invalid-feedback">
        {% for error in form.relation.errors %}
        <span>{{ error }}</span>
        {% endfor %}
        </div>
        {% else %}
        {{ form.relation(class='form-control') }}
        {% endif %}
    </div>
  </div></div>`;
  row_id.innerHTML=guardianbox_data+submitButton;

}

 /*
      Function to carry out the actual POST request to S3 using the signed request from the Python app.
    */
    function uploadFile(file, s3Data, url){
      const xhr = new XMLHttpRequest();
      //alert("the url being posted" + s3Data.url);
      xhr.open('POST', s3Data.url);
      xhr.setRequestHeader('x-amz-acl', 'public-read');
      const postData = new FormData();
      for(key in s3Data.fields){
        postData.append(key, s3Data.fields[key]);      
        //console.log(s3Data.fields[key]);
      }
      postData.append('file', file);
      //alert('This is the file' + file);
      //alert('This is the url' + url);
      xhr.onreadystatechange = () => {
        if(xhr.readyState === 4){
          if(xhr.status === 200 || xhr.status === 204){
            
            document.getElementById('preview').src = url;
            document.getElementById('reference').value = url;
          }
          else{
            window.alert("this is where the problem is");
            alert('Could not upload file.');
          }
        }
      };
      xhr.send(postData);
    }
    /*
      Function to get the temporary signed request from the Python app.
      If request successful, continue to upload the file using this signed
      request.
    */
    function getSignedRequest(file){
      const xhr = new XMLHttpRequest();

      xhr.open('GET', `/sign-s3?file-name=${file.name}&file-type=${file.type}`);
      xhr.onreadystatechange = () => {
        if(xhr.readyState === 4){
          if(xhr.status === 200){
            const response = JSON.parse(xhr.responseText);
            //alert("this is reponse data"+ response.data);
            //alert("this is reponse url"+ response.url);
            uploadFile(file, response.data, response.url);
          }
          else{
            alert('Could not get signed URL.');
          }
        }
      };
      xhr.send();
    }
    /*
       Function called when file input updated. If there is a file selected, then
       start upload procedure by asking for a signed request from the app.
    */
    function initUpload(){
      const files = document.getElementById('file-input').files;
      const file = files[0];
      if(!file){
        return alert('No file selected.');
      }
      getSignedRequest(file);
    }
    /*
       Bind listeners when the page loads.
    */
    (() => {
      document.getElementById('file-input').onchange = initUpload;
    })();

</script>
