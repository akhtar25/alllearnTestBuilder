<div class="container">
    <h3>Attendance</h3>    

    <form action="" method="POST">
        {{ form.hidden_tag() }}
      
        <div class="form-group " style="padding-top:5px;">
                <div class="row">
                        <div class="col-sm-3">
                                <div style="width:250px;">
                                        {{ form.class_val.label(class='labelsize') }}
                                        <br>
                                        {% if form.class_val.errors %}
                                        {{ form.class_val(class="form-control form-control-lg is-invalid") }}
                                        <div class="invalid-feedback">
                                        {% for error in form.class_val.errors %}
                                         <span>{{ error }}</span>
                                        {% endfor %}
                                        </div>
                                        {% else %}
                                        {{ form.class_val(class='form-control') }}
                                        {% endif %}
                                </div>
                        </div>
                        <div class="col-sm-2">
                                <div style="width:150px;" >
                                                {{ form.section.label(class='labelsize') }}
                                                <div id='loader'style='display: none; float: right;'>
                                                        <img src='../static/images/spinner.gif' width='25px' height='25px'>
                                        </div>

                                        <br>
                                                {% if form.section.errors %}
                                                {{ form.section(class="form-control form-control-lg is-invalid") }}
                                                <div class="invalid-feedback">
                                                {% for error in form.section.errors %}
                                                 <span>{{ error }}</span>
                                                {% endfor %}
                                                </div>
                                                {% else %}
                                                {{ form.section(class='form-control') }}
                                                {% endif %}

                                               
                                </div>
                        </div>
                        <p style="margin-top:23px; padding-left:3px;"><button class="btn waves-light green lighten-1 white-text" type="submit">Submit</button></p>
                </div>
               
                    
        </div>
            
    </form>
</div>

{% if student_list %}

<div class="card id" id="result_table">
        <h3 class="card-header text-center font-weight-bold text-uppercase py-4">Attendance</h3>
        <div class="card-body">
          <div id="table" class="table-editable">
            <table class="table table-bordered table-responsive-md table-striped text-center">
                    <thead>
                            <tr>
                                <th scope="col">Student Name</th>
                                {% for date in dates_list %}
                                <th scope="col">{{ date[0] }}</th>
                                {% endfor %}
                                <td>today</td>
                            </tr>
                    </thead>
                    <tbody>
                        <form action="" method="POST" name="form-upload">
                                {{ form1.hidden_tag() }}
                                <input type="hidden" name="upload_form" value="Upload">
                                
                            {% for student in student_list %}
                                <tr>
                                    <td> {{student.student_name }} </td>
                                    {% for %}
                                   
                                    <td>A</td>
                                    {% endfor %}
                                  <td><p>
                                        <label>
                                            <input id="absent_marker" name="absent_marker" type="checkbox">
                                            <span>Absent</span>
                                        </label>
                                    </p>    </td>
                                  
                                </tr>
                            {% endfor %}
                    </tbody>

            </table>
        
        </div>
        </div>
        
      </div>
      
      <p style="padding-left:575px;">{{ form1.upload(class="btn waves-light green lighten-1 white-text") }}</p>

      </form>

      

      {% endif %}




<script>
        var class_select = document.getElementById("class_val");
        var section_select = document.getElementById("section");
        class_select.onchange = function()  {
             
            class_val = class_select.value;
            $("#loader").show();
            
            fetch('/resultUpload/' + class_val).then(function(response) {
                response.json().then(function(data) {
                        $("#loader").hide();    
                        var optionHTML = '';
                        for (var section of data.sections) {
                        optionHTML += '<option value="' + section.section_val + '">' + section.section_val + '</option>';
                    }
                    section_select.innerHTML = optionHTML;
                })
                
            });
        }
    </script>




    #selectfield choices list
    teacher_id=TeacherProfile.query.filter_by(user_id=current_user.id).first()

    available_class=ClassSection.query.with_entities(ClassSection.class_val).distinct().filter_by(school_id=teacher_id.school_id).all()
    available_section=ClassSection.query.with_entities(ClassSection.section).distinct().filter_by(school_id=teacher_id.school_id).all()


    class_list=[(str(i.class_val), "Class "+str(i.class_val)) for i in available_class]
    section_list=[(i.section,i.section) for i in available_section]
    


    form=AttendenceQueryForm()
    form1=AttendanceForm()


    #selectfield choices
    form.class_val.choices = class_list
    form.section.choices= section_list

    if not form1.upload.data:
        if form.validate_on_submit() :
            if current_user.is_authenticated:
        
                #class_val=MessageDetails.query.filter_by(description=form.class_val.data).first()
                #sec_val=MessageDetails.query.filter_by(description=form.section.data).first()
                class_sec_id=ClassSection.query.filter_by(class_val=int(form.class_val.data),section=form.section.data).first()

                teacher_id=TeacherProfile.query.filter_by(user_id=current_user.id).first()

                student_list=StudentProfile.query.filter_by(class_sec_id=class_sec_id.class_sec_id,school_id=teacher_id.school_id).all()

           

                if student_list:
                    session['class_sec_id']=class_sec_id.class_sec_id
                    session['school_id']=teacher_id.school_id
                    session['teacher_id']=teacher_id.teacher_id

                    dates_list=Attendance.query.with_entities(Attendance.attendance_date).filter_by(class_sec_id=class_sec_id.class_sec_id,school_id=teacher_id.school_id,teacher_id=current_user.id).all()
                    attend_mark=Attendance.query.with_entities(Attendance.is_present).filter_by(class_sec_id=class_sec_id.class_sec_id,school_id=teacher_id.school_id,teacher_id=current_user.id).all()
                    
                    print(dates_list[0][0])
                    
                    return render_template('attendance.html',form=form,form1=form1,student_list=student_list,dates_list=dates_list)

                else:
                    flash('No Student list for the given class and section')
                   
                    return render_template('attendance.html', form=form)
        
                
            else:
                flash('Login required !')
                return render_template('resultUpload.html', form=form)

        else:
           return render_template('attendance.html',form=form)
    else:
        if form1.validate_on_submit:
            pass
        
            
    return render_template('attendence.html',form=form)