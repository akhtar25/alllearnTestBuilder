{% extends "layout.html" %} {% block content %}
{%if current_user.is_anonymous%}
<video autoplay muted loop id="myVideo"
style="position: absolute;right: 0;width: 100%;">
<source src="../static/images/vid1.mp4" type="video/mp4">
</video>
{%endif%}
<div style="background-image: linear-gradient(180deg,lightyellow, white,white);">
   
    <div class="container">
        <!--style="background-image: linear-gradient(135deg, lightgreen, white);"-->
        <br>
        <!--<ul class="tabs">
        <li class="tab col s3"><a class="active" href="#testSummaryDiv">Home</a></li>
        <li class="tab col s3"><a href="#testHistory">Test History</a></li>-->
        <!-- <li class="tab col s3"><a href="#payrollReport">Report</a></li>
        <li class="tab col s3"><a id="allocation" href="#teacherAllocation">Teacher Allocation</a></li>-->
        <!--</ul>-->
        <br>
        <!--<a href="#startTestModal" id="startTestModalBTN" class="modal-trigger right btn green">Start Practice Test</a><br>-->
        <!--<h4 class="">Hi, {{studentData.full_name}}</h4>-->
        <div id="mainDiv">
            {%if current_user.is_anonymous%}           
            <div class="col-xs-6 row">
                <span style="font-size: 48px;text-shadow: 1px 1px 1px black;" class="lime-text"><b>Preparing for exams needn't be tough. </b></span><br><span style="font-size: 24px;text-shadow: 1px 1px 1px black;" class="white-text"><b>Start practice test now.</b></span>
            </div>
            {%endif%}
            <div id="practiceTestDiv" class="col-xs-12 row " >
                <!--<div id="pointsDiv"  class="">
            <h5 >Points earned: <span class="green-text">240{{studentData.points_earned}}</span> </h5>
            <h5 >Level: <span class="blue-text">Pro {{studentData.current_level}}</span></h5>
        </div>-->

                <!--  <form>
            <div class="input-field">
              <input id="search" type="search" required>
              <i class="material-icons">close</i>
            </div>
          </form>-->
          {%if current_user.is_anonymous==false%}
          <h4>Start a test</h4>
          {%endif%}
                <div id="testConfigurationDiv">
                    <div class="z-depth-1 hoverable"
                        style="border-radius: 25px;border: 2px solid #73AD21;padding: 10px;background-image: linear-gradient(135deg, whitesmoke, white); ">
                        <div class="row">
                            <div class="col-xs-1">
                                <div class="input-field">
                                    <h4 class="grey-text">Class</h4>
                                    <select id="class_val">                                        
                                        <option selected value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-xs-2">
                                <div id='subjectLoader' style='display: none; float: right;margin-top: -25px;'>
                                    <img src='../static/images/spinner.gif' width='25px' height='25px'>
                                </div>
                                <div class="input-field">
                                    <h4 class="grey-text">Subject</h4>
                                    <select id="selectSubject">
                                        <option value="" disabled selected>Select Subject</option>                                        
                                    </select>
                                </div>
                            </div>
                            <div class="col-xs-5">
                                <!--The search should show Book-Chapter-Topic-->
                                <h4 class="grey-text">Enter Chapter/Topic</h4>
                                <div class="chips chips-autocomplete"><i class="material-icons right">search</i></div>
                            </div>
                            <div class="col-xs-2">
                                <div class="input-field">
                                    <h4 class="grey-text">Difficulty Preference</h4>                                    
                                    <select id="difficulty">                                        
                                        <option value="E">Easy</option>
                                        <option selected value="Me">Medium</option>
                                        <option value="H">Hard</option>                                        
                                    </select>
                                </div>
                            </div>
                            <div class="col-xs-2">
                                <div class="input-field">
                                    <h4 class="grey-text">Question Count</h4>
                                    <!--  <input style="font-size: xx-large;" class="green-text" type="number" min="0" max="100" id="qcount"
                    name="qcount">-->
                                    <select id="qcount" style="font-family: Arial;">                                        
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option selected value="20">20</option>
                                        <option value="30">30</option>
                                        <option value="40">40</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="">
                            <div class="center">
                                <br>
                                <a href="#" class="btn green hoverable" id="startTestBTN" style="width: 150px;">Start
                                    Test</a>
                                <span id="errorStartMSG" class="orange-text" style="display: none;">Error occurred while
                                    starting test. Please try again.</span>
                            </div>
                        </div>
                    </div>
                </div>
                <br><br>
                {%if current_user.is_anonymous==false%}
               <div class="row z-depth-1 hoverable" id="testSummaryDiv" style="border-radius: 25px;padding: 20px; ">
                    <h4>Performance Summary</h4>
                    <div class="box">                     
                        <div class="box-body table-responsive no-padding">
                            <div class="col-xs-3">
                                <h4 class="grey-text">Tests Taken</h4>
                                {%if studentData.tests_taken%}
                                <h3 class="green-text">{{studentData.tests_taken}}</h3>
                                {%else%}
                                <h3 class="green-text">NA</h3>
                                {%endif%}
                            </div>
                            <div class="col-xs-3">
                                <h4 class="grey-text">Average Performance</h4>
                                {%if avg_performance%}
                                <h3 class="blue-text">{{avg_performance}}%</h3>
                                {%else%}
                                <h3 class="blue-text">NA</h3>
                                {%endif%}
                            </div>
                            <div class="col-xs-3">
                                <h4 class="grey-text">Strength Subjects</h4>
                                {%if studentData.strength_subjects%}
                                <h3 class="green-text">{{studentData.strength_subjects}}</h3>
                                {%else%}
                                <h3 class="green-text">NA</h3>
                                {%endif%}
                            </div>
                            <div class="col-xs-3">
                                <h4 class="grey-text">Points earned</h4>
                                {%if studentData.points_earned%}
                                <h3 class="blue-text">{{studentData.points_earned}}</h3>
                                <h5>Level: <span class="purple-text"> {{studentData.current_level}}</span></h5>
                                {%else%}
                                <h3 class="blue-text">NA <span class="purple-text" style="font-size: 14px;"><b>NA</b>
                                        {{studentData.current_level}}</span></h3>
                                {%endif%}
                            </div>
                        </div>
                    </div>
                </div>

                <div id="testHistory" style="border-radius: 25px;padding: 20px; " class="z-depth-1 hoverable row">
                    <h4>Test History</h4>
                    <table class="highlight">
                        <thead>
                            <th>Subject</th>
                            <th>Topics</th>
                            <th>Test Date</th>
                            <th>Performance</th>
                            <th>See Report</th>
                        </thead>
                        <tbody>
                            {%if testHistory%}
                            {%for row in testHistory%}
                            <tr>
                                <td>{{row.subject}}</td>
                                <td><a href="#" class="seeTopicsBTNClass">See Topics</a></td>
                                <td>{{row.test_date.strftime('%d %B %Y')}}</td>
                                <td>{{row.performance}}</td>
                                <td><a href="#" class="seeReportClass"></a></td>
                            </tr>
                            {%endfor%}
                            {%endif%}
                        </tbody>
                    </table>
                </div>
                {%endif%}
                <br><br>
            </div>

        </div>
    </div>

    <!--<div id="startTestModal" class="modal" style="width: 400px;overflow-y: auto;">
        <div class="modal-content">            
            <span id="errorDisplay"></span>
            <h4 class="grey-text">Configure Test </h4>
            <h5><b>Class {{class_val}}</b></h5>
            <div class="row">
                <div class="col-xs-10">
                    <div id='subjectLoader' style='display: none; float: right;margin-top: -25px;'>
                        <img src='../static/images/spinner.gif' width='25px' height='25px'>
                    </div>
                    <div class="input-field">
                        <h4 class="grey-text">Subject</h4>
                        <select id="selectSubject">
                            <option value="" disabled selected>Select Subject</option>
                            {%if subjectData%}
                            {%for subject in subjectData%}
                            <option value="{{subject.msg_id}}">{{subject.description}}</option>
                            {%endfor%}
                            {%endif%}
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-10">
                    <div id='chapterLoader' style='display: none; float: right;margin-top: -25px;'>
                        <img src='../static/images/spinner.gif' width='25px' height='25px'>
                    </div>
                    <div class="input-field">
                        <h4 class="grey-text">Chapters and Topics</h4>
                        <select multiple id="selectChapters" style="font-family: Arial, Helvetica, sans-serif;">
                            <option value="" disabled selected>Select Chapters and topics</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-10">
                    <div class="input-field">
                        <h4 class="grey-text">Difficulty Preference</h4>
                        <select id="difficulty">
                            <option value="" disabled selected>Select Level</option>
                            <option value="E">Easy</option>
                            <option value="Me">Medium</option>
                            <option value="H">Hard</option>
                            <option value="Ma">Master</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-10">
                    <div class="questionenterDiv ">
                        <br>
                        <div class="input-field">
                            <h4 class="grey-text">Question Count</h4>
                            <select id="qcount" style="font-family: Arial;">
                                <option value="" disabled selected>Question Count</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="40">40</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="center">
                    <a href="#" class="btn green " id="startTestBTN" style="width: 150px;">Start</a>
                    <span id="errorStartMSG" class="orange-text" style="display: none;">Error occurred while starting
                        test.
                        Please try again.</span>
                </div>
            </div>
        </div>
    </div>-->


</div>
<script>
    $(document).ready(function () {
        $('.tabs').tabs();
        $('.modal').modal();
        $('select').formSelect();


        $('.chips-autocomplete').chips({
            placeholder: 'Enter Chapter/Topic',
            secondaryPlaceholder: '+More',
            autocompleteOptions: {
                data: {
                    'Apple': null,
                    'Microsoft': null,
                    'Google': null
                },
                limit: Infinity,
                minLength: 0
            }
        });

    });


$('#class_val').change(function(){
    //$('#selectSubject').html('<option value="" disabled selected>Select Subject</option>');
    $.ajax({ 
            url: "/addClass?class_val="+$('#class_val').val(),
            type: "POST",
            contentType: "application/json",
            data: "",
            success: function (response) {
              console.log('inside success');
                console.log(response);
                if(response){
                responseArr = response.toString().split(',');
                var optionHTML = '<option value="" disabled selected>Select Subject</option>';
              for(var i=0;i<responseArr.length;i++){
                var subject_id = responseArr[i].toString().split(':')[0];
                var subject_name = responseArr[i].toString().split(':')[1];
                console.log(subject_id);
                console.log(subject_name);
                optionHTML +='<option value="' + subject_id + '">' + subject_name + '</option>';                
              }
            }else{
                optionHTML +='<option value="">No data available</option>';
            }
              console.log(optionHTML);
              //console.log(select_subject);
              $('#selectSubject').innerHTML = optionHTML;
              $('#subjectLoader').hide();
              $('#selectSubject').formSelect();
            },
            error: function (xhr) { 
                window.alert("error occurred while loading subject");
            }
        });
});


    //$("#qcount").on("keypress keyup blur", function (e) {
    //    $(this).val($(this).val().replace(/^[a-zA-Z]+$/, ""));
    //    if ($(this).val()>100)
    //    {
    //        $("#qcount").prop('disable',true);
    //    }
    //    if ((e.which < 48 || e.which > 57)) {
    //        e.preventDefault();
    //    }
    //});

    var select_chapter = document.getElementById('selectChapters');

    $('#selectSubject').change(function () {
        //select_subject.onchange = function () {
        $("#filebox").html('');
        $('#chapterLoader').show();
        $('#selectChapters').html('');
        console.log('inside subject onchange');
        var subject_id = $('#selectSubject').val();

        var class_val = "{{class_val}}";
        //var test_type = select_test.value;
        //var date = $('#test_date').val();
        //topics = $('#selectChapters').val();
        //if (subject_id && class_val && test_type && date && topics) {
        //    console.log('if all are not empty');
        //    $('#questionSubmitBtn').prop('disabled', false);
        //} else {
        //    console.log('if all are empty');
        //    $('#questionSubmitBtn').prop('disabled', true);
        //}
        //var subject_id = select_subject.value;

        $.ajax({
            url: "/addChapterTopics?class_val=" + class_val + "&subject_id=" + subject_id,
            type: "POST",
            contentType: "/application/json",
            data: "",
            success: function (response) {
                if (response) {
                    responseArr = response.toString().split('/,/');
                    var optionHTML =
                        '<option value="" disabled selected style="font-family:arial">Select Chapters and topics</option>';
                    var bookNames = [];
                    for (var i = 0; i < responseArr.length; i++) {
                        var book_name = responseArr[i].toString().split(':')[0];
                        var topic_name = responseArr[i].toString().split(':')[1];
                        var chapter_name = responseArr[i].toString().split(':')[2];
                        var topic_id = responseArr[i].toString().split(':')[3];
                        if (bookNames.includes(book_name) == false) {
                            console.log(bookNames);
                            console.log('value:' + bookNames.includes(book_name));
                            optionHTML += '<optgroup label="' + book_name + '"></optgroup>';
                        }
                        bookNames.push(book_name);
                        optionHTML += '<option value="' + topic_id +
                            '" name="topic_ids"><span style="font-size:14;font-family:Arial;"> ' +
                            chapter_name + ' - ' + topic_name + '</span></option></optgroup>';
                    }
                } else {
                    optionHTML +=
                        '<option value="" name="topic_ids" disabled selected>No data available</option>'
                }
                select_chapter.innerHTML = optionHTML;
                $('#chapterLoader').hide();

                $('#selectChapters').formSelect();
            },
            error: function (xhr) {
                //window.alert('error occured while loading chapters');
                $('#errorDisplay').html(
                    '<span class="red-text">Error occurred while loading chapters. <br>Please try again</span>'
                )
            }
        });
        $('#testBuilderQuestions').hide();
        $("questions").hide();
        $('#questionloader').show();
    });


    $('#startTestBTN').click(function () {
        var topics = $('#selectChapters').val();
        var difficulty = $('#difficulty').val();
        var qcount = $('#qcount').val();
        var selectSubject = $('#selectSubject').val();
        var class_val = "{{class_val}}";
        var topicList = JSON.stringify(topics);
        $.ajax({
            url: "/startPracticeTest?difficulty=" + difficulty + "&qcount=" + qcount + "&subject_id=" +
                selectSubject + "&class_val=" + class_val,
            type: "POST",
            contentType: "application/json",
            data: topicList,
            success: function (response) {
                if (response == 1) {
                    $('#errorStartMSG').show();
                } else {
                    $('#errorStartMSG').hide();
                    window.location.href = "/feedbackCollectionStudDev?resp_session_id=" + response;
                }
            },
            error: function (xhr) {
                $('#errorStartMSG').html('Error in fetching server response. Please try again.');
            }
        });
    });
</script>
{% endblock %}